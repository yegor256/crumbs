% (The MIT License)
%
% Copyright (c) 2021 Yegor Bugayenko
%
% Permission is hereby granted, free of charge, to any person obtaining a copy
% of this software and associated documentation files (the 'Software'), to deal
% in the Software without restriction, including without limitation the rights
% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
% copies of the Software, and to permit persons to whom the Software is
% furnished to do so, subject to the following conditions:
%
% The above copyright notice and this permission notice shall be included in all
% copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
% SOFTWARE.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{crumbs}[00.00.0000 0.0.0 Navigation Crumbs]

\RequirePackage{etoolbox}

\newcommand\subcrumbs{
  \expandafter\ifcsname crumbs\romannumeral\the\value{section}\endcsname
    \csname crumbs\romannumeral\the\value{section}\endcsname{}
  \fi
}

% see https://tex.stackexchange.com/a/12414/1449
\RequirePackage{catchfile}
  \newwrite\appendwrite
  \newcommand*\appendtofile[2]{%
    \begingroup
    \IfFileExists{#1}%
      {\CatchFileDef{\filecontent}{#1}{\endlinechar=`^^J\catcode\endlinechar=12\relax}}% keep existing end-of-lines
      {\let\filecontent\empty}%
    \immediate\openout\appendwrite=#1\relax
    \immediate\write\appendwrite{\unexpanded\expandafter{\filecontent} #2}%
    \immediate\closeout\appendwrite
    \endgroup
  }

\makeatletter\newcommand\back{\@backslashchar}\makeatother

\let\oldsection\section
\renewcommand\section[1]{
  \ifx\crumbs\empty
    \appendtofile{\jobname.crumbs}{\back TOCRUMBS{0}{#1}}
  \fi
  \oldsection{#1}
}

\let\oldsubsection\subsection
\renewcommand\subsection[1]{
  \ifx\crumbs\empty
    \appendtofile{\jobname.crumbs}{\back TOCRUMBS{\the\value{section}}{#1}}
  \fi
  \oldsubsection{#1}
}

\newcommand\TOCRUMBS[2]{
  \ifcsname crumbs\romannumeral#1\endcsname\else
    \expandafter\newcommand\expandafter*\csname crumbs\romannumeral#1\endcsname{}
  \fi
  \expandafter\gappto\csname crumbs\romannumeral#1\endcsname{#2}
}

\newcommand*\crumbs{}
\IfFileExists{\jobname.crumbs}{\input{\jobname.crumbs}}{}

\endinput
